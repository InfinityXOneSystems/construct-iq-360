name: üîó Optional Integration: Infinity Vision Commands

on:
  # Optional: Listen for commands from external systems like Infinity Vision
  # construct-iq-360 operates autonomously without this integration
  repository_dispatch:
    types:
      - vision-command
      - vision-sync
      - vision-health-check
  
  # Also allow manual triggering
  workflow_dispatch:
    inputs:
      command:
        description: 'Command from Infinity Vision'
        required: false
        default: 'sync'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  process-external-command:
    name: Process External Command (Optional Integration)
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
      
      - name: üîó Process Command from External System
        run: |
          echo "============================================="
          echo "üîó EXTERNAL COMMAND RECEIVED (OPTIONAL)"
          echo "construct-iq-360 is fully autonomous"
          echo "This integration is optional and supplemental"
          echo "============================================="
          echo "Event Type: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          
          # Extract command from dispatch payload
          COMMAND="${{ github.event.client_payload.command || inputs.command }}"
          echo "Command: $COMMAND"
          
          # Process different commands
          case "$COMMAND" in
            "sync")
              echo "‚úÖ Synchronization command received"
              echo "üìä Current system status: ONLINE"
              ;;
            "health-check")
              echo "‚úÖ Health check command received"
              echo "üíö System health: OPTIMAL"
              ;;
            "trigger-hunter")
              echo "‚úÖ Triggering Hunter Agent..."
              echo "üéØ Hunter will execute on next scheduled run"
              ;;
            *)
              echo "‚ÑπÔ∏è  Unknown command: $COMMAND"
              echo "üìã Available commands: sync, health-check, trigger-hunter"
              ;;
          esac
      
      - name: üìù Update Active Memory (Optional)
        run: |
          # Update the active memory with integration event timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "üìù Logging external integration event: $TIMESTAMP"
          
          # Append sync event to active memory
          echo "" >> .infinity/ACTIVE_MEMORY.md
          echo "-   \`[$TIMESTAMP]\` Optional Integration: External command received and processed." >> .infinity/ACTIVE_MEMORY.md
          
          # Check if there are changes to commit
          if [[ -n $(git status --porcelain) ]]; then
            git config user.name "External Integration"
            git config user.email "integration@construct-iq-360.ai"
            git add .infinity/ACTIVE_MEMORY.md
            git commit -m "üîó External integration event: $TIMESTAMP"
            git push
            echo "‚úÖ Active memory updated and committed"
          else
            echo "‚ÑπÔ∏è  No changes to commit"
          fi
      
      - name: üìä Report Status
        run: |
          echo "============================================="
          echo "‚úÖ EXTERNAL COMMAND PROCESSED"
          echo "============================================="
          echo "System: construct-iq-360"
          echo "Type: Fully Autonomous End-to-End System"
          echo "Status: OPERATIONAL (24/7)"
          echo "External Integration: OPTIONAL"
          echo "============================================="
      
      - name: üö® Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® External Integration Processing Failure - ' + new Date().toISOString(),
              body: '**System Alert**: Failed to process external command. Note: construct-iq-360 operates autonomously regardless of external integrations.\n\nWorkflow Run: ' + context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId,
              labels: ['bug', 'automated', 'external-integration']
            })
