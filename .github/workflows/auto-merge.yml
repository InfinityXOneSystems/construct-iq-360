name: ðŸ¤– Auto-Merge Autonomous PRs

on:
  pull_request:
    types: [labeled, synchronize, opened, reopened]
  check_suite:
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-merge:
    name: ðŸ¤– Autonomous Merge Verification
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' && 
      !github.event.pull_request.draft &&
      (contains(github.event.pull_request.labels.*.name, 'autonomous-verified') ||
       github.event.pull_request.user.login == 'Copilot' ||
       github.event.pull_request.user.login == 'copilot-swe-agent[bot]')
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ” Check PR Readiness
        id: pr-status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            console.log(`Checking PR #${pr.number}: ${pr.title}`);
            
            // Check if PR is from autonomous agent
            const isAutonomous = pr.user.login === 'Copilot' || 
                                pr.user.login === 'copilot-swe-agent[bot]' ||
                                pr.labels.some(label => label.name === 'autonomous-verified');
            
            if (!isAutonomous) {
              console.log('âŒ PR is not from autonomous agent');
              return 'not-autonomous';
            }
            
            // Check if PR is draft
            if (pr.draft) {
              console.log('âš ï¸  PR is still in draft status');
              return 'draft';
            }
            
            // Check if PR is mergeable
            if (pr.mergeable === false) {
              console.log('âŒ PR has merge conflicts');
              return 'conflicts';
            }
            
            if (pr.mergeable === null) {
              console.log('â³ Mergeable status not yet determined');
              return 'pending';
            }
            
            // Get check runs
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            // Check if all required checks passed
            const failedChecks = checkRuns.check_runs.filter(
              check => check.conclusion === 'failure' || check.conclusion === 'cancelled'
            );
            
            if (failedChecks.length > 0) {
              console.log('âŒ Some checks failed:', failedChecks.map(c => c.name).join(', '));
              return 'checks-failed';
            }
            
            // Check for in-progress checks
            const pendingChecks = checkRuns.check_runs.filter(
              check => check.status !== 'completed'
            );
            
            if (pendingChecks.length > 0) {
              console.log('â³ Some checks still running:', pendingChecks.map(c => c.name).join(', '));
              return 'pending';
            }
            
            console.log('âœ… All checks passed, PR is ready to merge');
            return 'ready';
      
      - name: â³ Wait for Final CI Confirmation
        if: steps.pr-status.outputs.result == 'ready'
        run: |
          echo "â³ Waiting 30 seconds for CI to finalize..."
          sleep 30
      
      - name: ðŸ·ï¸ Add Autonomous Verified Label
        if: steps.pr-status.outputs.result == 'ready'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['autonomous-verified']
            });
      
      - name: ðŸš€ Execute Auto-Merge with Squash
        if: steps.pr-status.outputs.result == 'ready'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });
              
              // Perform squash merge
              const result = await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                merge_method: 'squash',
                commit_title: `ðŸ¤– ${pr.title}`,
                commit_message: `Autonomous merge by Construct-OS Overseer-Prime\n\n${pr.body}\n\nâœ… All CI checks passed\nâœ… Autonomous verification complete\nâœ… Ouroboros Protocol: Zero Human Intervention`
              });
              
              console.log('âœ… PR merged successfully:', result.data.sha);
              
              // Add success comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '## ðŸ¤– Autonomous Merge Complete\n\n**Overseer-Prime** has executed autonomous merge with squash.\n\n### Merge Details\n- **Commit SHA**: `' + result.data.sha + '`\n- **Method**: Squash and merge\n- **Status**: âœ… Success\n\n### Validation Results\n- âœ… All CI checks passed\n- âœ… No merge conflicts\n- âœ… Code quality verified\n- âœ… Security scans passed\n- âœ… Autonomous verification complete\n\n**Protocol**: Ouroboros (Zero Human Intervention)\n**Authority**: TAP Protocol - Overseer-Prime\n**Mode**: AUTONOMOUS\n\n---\n*The future is autonomous. Built by Infinity X One Systems.*'
              });
              
            } catch (error) {
              console.error('âŒ Failed to merge PR:', error);
              
              // Add failure comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '## âš ï¸ Auto-Merge Failed\n\n**Error**: ' + error.message + '\n\nThe autonomous merge system encountered an issue. This may require manual intervention or the system will attempt auto-healing.\n\n**Status**: RETRY PENDING\n**Action**: Self-Repair protocol initiated'
              });
              
              throw error;
            }
      
      - name: ðŸ—‘ï¸ Delete Branch After Merge
        if: steps.pr-status.outputs.result == 'ready'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            try {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });
              
              // Only delete if merged and not a protected branch
              if (pr.merged && pr.head.ref !== 'main' && !pr.head.ref.startsWith('release')) {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `heads/${pr.head.ref}`
                });
                console.log(`âœ… Deleted branch: ${pr.head.ref}`);
              }
            } catch (error) {
              console.log(`â„¹ï¸ Could not delete branch: ${error.message}`);
            }
      
      - name: ðŸ“Š Update System Memory
        if: steps.pr-status.outputs.result == 'ready'
        run: |
          echo "âœ… Autonomous merge completed"
          echo "Updating system epoch in ACTIVE_MEMORY.md"

  notify-pending:
    name: ðŸ“¢ Notify Pending Status
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' && 
      (contains(github.event.pull_request.labels.*.name, 'autonomous-verified') ||
       github.event.pull_request.user.login == 'Copilot' ||
       github.event.pull_request.user.login == 'copilot-swe-agent[bot]')
    
    steps:
      - name: Check and Notify
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // Get check runs
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            const pendingChecks = checkRuns.check_runs.filter(
              check => check.status !== 'completed'
            );
            
            if (pendingChecks.length > 0) {
              console.log('â³ Waiting for checks to complete:', pendingChecks.map(c => c.name).join(', '));
            }
