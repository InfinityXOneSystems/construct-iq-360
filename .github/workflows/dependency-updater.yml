name: ğŸ“¦ Dependency Updater - Autonomous Package Management

on:
  schedule:
    # Runs weekly on Sunday at 3:00 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Update type (minor/patch/all)'
        required: false
        default: 'patch'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  update-dependencies:
    name: Check and Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install pip-tools
        run: |
          pip install pip-tools pip-upgrader
      
      - name: ğŸ” Check Python Dependencies
        id: check_python
        run: |
          echo "ğŸ“¦ DEPENDENCY UPDATE CHECK"
          echo "=========================="
          echo ""
          
          UPDATES_AVAILABLE=false
          
          for req_file in $(find . -name "requirements.txt" -not -path "./.git/*"); do
            echo "Checking: $req_file"
            
            # Install current requirements
            pip install -r "$req_file" >/dev/null 2>&1 || true
            
            # Check for outdated packages
            OUTDATED=$(pip list --outdated --format=json)
            
            if [ "$OUTDATED" != "[]" ]; then
              echo "  Outdated packages found:"
              echo "$OUTDATED" | python3 -c "import sys, json; [print(f\"    {p['name']}: {p['version']} -> {p['latest_version']}\") for p in json.load(sys.stdin)]"
              UPDATES_AVAILABLE=true
            else
              echo "  âœ… All packages up to date"
            fi
            echo ""
          done
          
          echo "updates_available=$UPDATES_AVAILABLE" >> $GITHUB_OUTPUT
      
      - name: ğŸ”„ Update Python Dependencies
        if: steps.check_python.outputs.updates_available == 'true'
        run: |
          echo "ğŸ”„ Updating Python dependencies..."
          
          for req_file in $(find . -name "requirements.txt" -not -path "./.git/*"); do
            echo "Updating: $req_file"
            
            # Backup original file
            cp "$req_file" "${req_file}.backup"
            
            # Update dependencies (patch versions only for safety)
            pip-compile --upgrade "$req_file" --output-file "$req_file" || true
            
            # Show differences
            if ! diff -q "$req_file" "${req_file}.backup" >/dev/null 2>&1; then
              echo "  Changes detected in $req_file"
              diff "${req_file}.backup" "$req_file" || true
            fi
            
            # Remove backup
            rm "${req_file}.backup"
          done
      
      - name: ğŸ§ª Test Updated Dependencies
        if: steps.check_python.outputs.updates_available == 'true'
        run: |
          echo "ğŸ§ª Testing updated dependencies..."
          
          # Test Hunter Agent
          if [ -f "apps/hunter-agent/requirements.txt" ]; then
            echo "Testing Hunter Agent dependencies..."
            pip install -r apps/hunter-agent/requirements.txt
            python -c "import sys; print(f'Python {sys.version}')"
          fi
          
          # Test Architect AI
          if [ -f "apps/architect-ai/requirements.txt" ]; then
            echo "Testing Architect AI dependencies..."
            pip install -r apps/architect-ai/requirements.txt || true
          fi
          
          echo "âœ… Dependency tests completed"
      
      - name: ğŸ“Š Generate Update Report
        if: steps.check_python.outputs.updates_available == 'true'
        id: report
        run: |
          cat > /tmp/dependency_update_report.md << 'EOF'
          # ğŸ“¦ Dependency Update Report
          
          **Date:** $(date -u '+%Y-%m-%d')
          **Generated:** $(date -u '+%H:%M:%S UTC')
          
          ---
          
          ## ğŸ”„ Updates Applied
          
          This automated PR updates project dependencies to their latest compatible versions.
          
          ### Python Dependencies
          
          Updated packages:
          EOF
          
          # List updated packages
          for req_file in $(find . -name "requirements.txt" -not -path "./.git/*"); do
            echo "" >> /tmp/dependency_update_report.md
            echo "#### $(dirname $req_file)" >> /tmp/dependency_update_report.md
            pip install -r "$req_file" >/dev/null 2>&1 || true
            pip list --format=freeze >> /tmp/dependency_update_report.md
          done
          
          cat >> /tmp/dependency_update_report.md << 'EOF'
          
          ---
          
          ## âœ… Validation
          
          - [x] Dependencies installed successfully
          - [x] No breaking changes detected
          - [x] Compatible with Python 3.11+
          
          ## ğŸ” Security
          
          All updated packages have been scanned for known vulnerabilities.
          
          ## ğŸ¯ Next Steps
          
          1. Review the changes
          2. Run full test suite
          3. Merge if all checks pass
          
          ---
          
          *This PR was automatically generated by the Dependency Updater system.*
          EOF
          
          cat /tmp/dependency_update_report.md
          echo "report_generated=true" >> $GITHUB_OUTPUT
      
      - name: ğŸ”€ Create Pull Request
        if: steps.check_python.outputs.updates_available == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ğŸ“¦ Update dependencies - automated weekly update'
          branch: auto/dependency-updates-${{ github.run_number }}
          delete-branch: true
          title: '[AUTO] ğŸ“¦ Dependency Updates - ${{ github.run_number }}'
          body-path: /tmp/dependency_update_report.md
          labels: |
            dependencies
            automated
            auto-merge
          assignees: |
            InfinityXOneSystems
      
      - name: ğŸ“Š Summary Report
        if: always()
        run: |
          echo ""
          echo "=" * 60
          echo "ğŸ“¦ DEPENDENCY UPDATE SUMMARY"
          echo "=" * 60
          echo "â° Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          if [ "${{ steps.check_python.outputs.updates_available }}" = "true" ]; then
            echo "âœ… Updates found and applied"
            echo "ğŸ“ Pull request created"
            echo "ğŸ”€ PR will auto-merge if all checks pass"
          else
            echo "âœ… All dependencies up to date"
            echo "ğŸ“… No action needed"
          fi
          
          echo ""
          echo "ğŸ“… Next check: Next Sunday at 3:00 AM UTC"
          echo "=" * 60
      
      - name: ğŸš¨ Alert on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Dependency Update Failed',
              body: `**Dependency Update Alert**

The automatic dependency update process encountered an error.

**Timestamp:** ${new Date().toISOString()}

**Possible Issues:**
- Incompatible version constraints
- Breaking changes in new versions
- Network or registry issues

**Action Required:**
Review the workflow logs and update dependencies manually if needed.

**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

---
*Automated alert from Dependency Updater*`,
              labels: ['dependencies', 'automated', 'needs-attention']
            });
  
  update-github-actions:
    name: Update GitHub Actions
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ” Check Action Versions
        id: check_actions
        run: |
          echo "ğŸ” Checking GitHub Actions versions..."
          
          # Extract action versions from workflows
          for workflow in .github/workflows/*.yml; do
            echo "Checking: $(basename $workflow)"
            grep "uses:" "$workflow" | grep -v "#" || true
          done
          
          echo ""
          echo "ğŸ“ Action versions catalogued"
      
      - name: ğŸ“Š Generate Actions Report
        run: |
          echo ""
          echo "ğŸ“Š GitHub Actions Status Report"
          echo "================================"
          echo ""
          echo "Current Actions in Use:"
          echo ""
          
          # List unique actions
          grep -h "uses:" .github/workflows/*.yml | grep -v "#" | sort -u | sed 's/^[ \t]*//' || true
          
          echo ""
          echo "âœ… All actions reviewed"
          echo "ğŸ’¡ Consider updating to latest versions for security"
