name: ðŸ”„ Genesis Loop - Autonomous Self-Optimization

on:
  schedule:
    # Runs every 6 hours for continuous self-improvement
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      scan_depth:
        description: 'Scan depth (shallow/deep)'
        required: false
        default: 'shallow'

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  genesis-scan:
    name: Self-Analysis & Optimization
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ§  Load Active Memory
        id: load_memory
        run: |
          echo "ðŸ§  Loading system state from Active Memory..."
          if [ -f ".infinity/ACTIVE_MEMORY.md" ]; then
            echo "âœ… Memory file found"
            cat .infinity/ACTIVE_MEMORY.md
          else
            echo "âš ï¸ Memory file missing - system may need initialization"
          fi
          echo "timestamp=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
      
      - name: ðŸ” Analyze Repository Structure
        id: analyze
        run: |
          echo "ðŸ” GENESIS LOOP: REPOSITORY ANALYSIS"
          echo "===================================="
          echo ""
          
          # Count files by type
          echo "ðŸ“Š Code Metrics:"
          echo "  Python files: $(find . -name '*.py' | wc -l)"
          echo "  YAML workflows: $(find .github/workflows -name '*.yml' | wc -l)"
          echo "  Markdown docs: $(find . -name '*.md' | wc -l)"
          echo ""
          
          # Check for common issues
          echo "ðŸ” Issue Detection:"
          ISSUES_FOUND=0
          
          # Check for TODO comments
          TODO_COUNT=$(grep -r "TODO" apps/ 2>/dev/null | wc -l)
          echo "  TODO items: $TODO_COUNT"
          if [ $TODO_COUNT -gt 0 ]; then
            ISSUES_FOUND=$((ISSUES_FOUND + TODO_COUNT))
          fi
          
          # Check for deprecated patterns
          DEPRECATED_COUNT=$(grep -r "datetime.utcnow()" apps/ 2>/dev/null | wc -l)
          if [ $DEPRECATED_COUNT -gt 0 ]; then
            echo "  âš ï¸ Deprecated datetime usage: $DEPRECATED_COUNT"
            ISSUES_FOUND=$((ISSUES_FOUND + DEPRECATED_COUNT))
          fi
          
          # Check for missing error handling
          TRY_COUNT=$(grep -r "try:" apps/ 2>/dev/null | wc -l)
          EXCEPT_COUNT=$(grep -r "except:" apps/ 2>/dev/null | wc -l)
          echo "  Error handlers: $EXCEPT_COUNT try/except blocks"
          
          echo ""
          echo "issues_found=$ISSUES_FOUND" >> $GITHUB_OUTPUT
      
      - name: ðŸ“ˆ Performance Analysis
        id: performance
        run: |
          echo "ðŸ“ˆ Analyzing performance characteristics..."
          
          # Check for performance anti-patterns
          echo "  Checking for blocking operations..."
          BLOCKING=$(grep -r "time.sleep\|requests.get" apps/ 2>/dev/null | wc -l)
          echo "    Potential blocking calls: $BLOCKING"
          
          # Check for caching opportunities
          echo "  Checking for caching opportunities..."
          CACHE_OPP=$(grep -r "@cache\|@lru_cache" apps/ 2>/dev/null | wc -l)
          echo "    Cached functions: $CACHE_OPP"
          
          # Check workflow efficiency
          echo "  Workflow efficiency metrics:"
          for workflow in .github/workflows/*.yml; do
            NAME=$(basename "$workflow")
            STEPS=$(grep -c "- name:" "$workflow" || echo "0")
            echo "    $NAME: $STEPS steps"
          done
      
      - name: ðŸ” Security Scan
        id: security
        run: |
          echo "ðŸ” Performing security analysis..."
          
          # Check for hardcoded secrets (basic patterns)
          echo "  Scanning for potential secrets..."
          SECRET_PATTERNS=$(grep -rE "(password|api[_-]?key|secret|token)\s*=\s*['\"]" apps/ 2>/dev/null | wc -l)
          echo "    Potential hardcoded secrets: $SECRET_PATTERNS"
          
          # Check for unsafe operations
          echo "  Checking for unsafe operations..."
          UNSAFE=$(grep -rE "(eval\(|exec\(|os\.system)" apps/ 2>/dev/null | wc -l)
          echo "    Unsafe operations: $UNSAFE"
          
          # Check permissions
          echo "  Workflow permissions audit:"
          for workflow in .github/workflows/*.yml; do
            NAME=$(basename "$workflow")
            if grep -q "permissions:" "$workflow"; then
              echo "    âœ… $NAME has explicit permissions"
            else
              echo "    âš ï¸  $NAME using default permissions"
            fi
          done
      
      - name: ðŸŽ¯ Generate Optimization Recommendations
        id: recommendations
        run: |
          echo "ðŸŽ¯ OPTIMIZATION RECOMMENDATIONS"
          echo "================================"
          
          RECOMMENDATIONS=""
          
          # Check if improvements are needed
          if [ ${{ steps.analyze.outputs.issues_found }} -gt 10 ]; then
            RECOMMENDATIONS="${RECOMMENDATIONS}\n- ðŸ”§ High number of TODO items - consider prioritization"
          fi
          
          if [ ! -f "apps/hunter-agent/config.json" ]; then
            RECOMMENDATIONS="${RECOMMENDATIONS}\n- âš™ï¸  Missing configuration files - add runtime configs"
          fi
          
          if [ ! -f ".github/workflows/auto-merge.yml" ]; then
            RECOMMENDATIONS="${RECOMMENDATIONS}\n- ðŸ¤– Add auto-merge workflow for autonomous operations"
          fi
          
          if [ ! -f ".github/workflows/repo-scanner.yml" ]; then
            RECOMMENDATIONS="${RECOMMENDATIONS}\n- ðŸ“¡ Add 24/7 repository scanner workflow"
          fi
          
          if [ ! -f ".github/workflows/daily-analysis.yml" ]; then
            RECOMMENDATIONS="${RECOMMENDATIONS}\n- ðŸ“Š Add daily analysis workflow"
          fi
          
          if [ ! -f ".github/workflows/ai-recommender.yml" ]; then
            RECOMMENDATIONS="${RECOMMENDATIONS}\n- ðŸ§  Add AI technology recommendation system"
          fi
          
          if [ -n "$RECOMMENDATIONS" ]; then
            echo "Recommendations:$RECOMMENDATIONS"
            echo "has_recommendations=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… System is optimally configured"
            echo "has_recommendations=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ’¾ Update System State
        run: |
          echo "ðŸ’¾ Updating active memory with scan results..."
          
          # Update the last update timestamp in ACTIVE_MEMORY.md
          if [ -f ".infinity/ACTIVE_MEMORY.md" ]; then
            sed -i "s/\*\*Last Update:\*\* .*/\*\*Last Update:\*\* ${{ steps.load_memory.outputs.timestamp }}/" .infinity/ACTIVE_MEMORY.md
            
            # Add Genesis Loop log entry if not already present today
            CURRENT_DATE=$(date -u '+%Y-%m-%d')
            if ! grep -q "$CURRENT_DATE.*Genesis Loop" .infinity/ACTIVE_MEMORY.md; then
              sed -i "/## ðŸ“œ Recent Logs/a -   \[\`${{ steps.load_memory.outputs.timestamp }}\`\] Genesis Loop completed - Issues: ${{ steps.analyze.outputs.issues_found }}" .infinity/ACTIVE_MEMORY.md
            fi
            
            # Commit changes if any
            if [ -n "$(git status --porcelain)" ]; then
              git config user.name "Genesis Loop Bot"
              git config user.email "genesis@construct-os.ai"
              git add .infinity/ACTIVE_MEMORY.md
              git commit -m "ðŸ”„ Genesis Loop: Self-optimization scan at ${{ steps.load_memory.outputs.timestamp }}"
              git push
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ“Š Generate Report
        run: |
          echo ""
          echo "=" * 60
          echo "ðŸ”„ GENESIS LOOP EXECUTION SUMMARY"
          echo "=" * 60
          echo "â° Timestamp: ${{ steps.load_memory.outputs.timestamp }}"
          echo "ðŸ” Issues Detected: ${{ steps.analyze.outputs.issues_found }}"
          echo "ðŸŽ¯ Recommendations: ${{ steps.recommendations.outputs.has_recommendations }}"
          echo ""
          echo "âœ… Genesis Loop completed successfully"
          echo "Next scan: In 6 hours"
          echo "=" * 60
      
      - name: ðŸš¨ Create Issue for Critical Findings
        if: steps.analyze.outputs.issues_found > 50 || steps.recommendations.outputs.has_recommendations == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ”„ Genesis Loop: Optimization Recommendations Available';
            const body = `**Genesis Loop Scan Results**

**Timestamp:** ${{ steps.load_memory.outputs.timestamp }}
**Issues Detected:** ${{ steps.analyze.outputs.issues_found }}

The Genesis Loop has identified opportunities for system optimization. Review the workflow logs for detailed recommendations.

**Automated Actions:**
- System state updated in Active Memory
- Performance metrics collected
- Security scan completed

**Next Steps:**
Consider implementing the recommended optimizations to improve system performance and maintainability.

---
*This is an automated report from the Genesis Loop self-optimization system.*`;
            
            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'genesis-loop'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['genesis-loop', 'automated', 'optimization']
              });
            }
