name: üé≠ PR Orchestrator - Autonomous PR Management

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  schedule:
    # Run every 30 minutes to check PR status
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: read

jobs:
  manage-autonomous-prs:
    name: üéØ Manage Autonomous PRs
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîç Discover Autonomous PRs
        id: discover
        uses: actions/github-script@v7
        with:
          script: |
            console.log('üîç DISCOVERING AUTONOMOUS PRs');
            console.log('============================');
            
            // Get all open PRs
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            console.log(`Found ${pulls.length} open PRs`);
            
            // Filter for autonomous PRs
            const autonomousPRs = pulls.filter(pr => 
              pr.user.login === 'Copilot' || 
              pr.user.login === 'copilot-swe-agent[bot]' ||
              pr.labels.some(label => label.name === 'autonomous-verified')
            );
            
            console.log(`Found ${autonomousPRs.length} autonomous PRs`);
            
            // Output PR numbers for processing
            const prNumbers = autonomousPRs.map(pr => pr.number).join(',');
            core.setOutput('pr_numbers', prNumbers);
            core.setOutput('pr_count', autonomousPRs.length.toString());
            
            return autonomousPRs.map(pr => ({
              number: pr.number,
              title: pr.title,
              draft: pr.draft,
              mergeable: pr.mergeable,
              mergeable_state: pr.mergeable_state
            }));
      
      - name: üîÑ Process Each Autonomous PR
        if: steps.discover.outputs.pr_count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumbers = '${{ steps.discover.outputs.pr_numbers }}'.split(',');
            
            console.log('üîÑ PROCESSING AUTONOMOUS PRs');
            console.log('===========================');
            
            for (const prNumber of prNumbers) {
              console.log(`\nüìã Processing PR #${prNumber}`);
              
              try {
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: parseInt(prNumber)
                });
                
                console.log(`  Title: ${pr.title}`);
                console.log(`  Draft: ${pr.draft}`);
                console.log(`  Mergeable: ${pr.mergeable}`);
                console.log(`  State: ${pr.mergeable_state}`);
                
                // Check if PR is draft
                if (pr.draft) {
                  console.log(`  ‚ö†Ô∏è  PR #${prNumber} is in draft status`);
                  
                  // Get check runs
                  const { data: checkRuns } = await github.rest.checks.listForRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: pr.head.sha
                  });
                  
                  // Check if all checks passed
                  const allChecksPassed = checkRuns.check_runs.every(
                    check => check.conclusion === 'success' || check.conclusion === 'skipped' || check.conclusion === null
                  );
                  
                  const anyChecksFailed = checkRuns.check_runs.some(
                    check => check.conclusion === 'failure' || check.conclusion === 'cancelled'
                  );
                  
                  if (anyChecksFailed) {
                    console.log(`  ‚ùå Some checks failed, keeping as draft`);
                    continue;
                  }
                  
                  // Check if PR has conflicts
                  if (pr.mergeable === false) {
                    console.log(`  ‚ö†Ô∏è  PR has merge conflicts`);
                    
                    // Add comment about conflicts
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: parseInt(prNumber),
                      body: '## ‚ö†Ô∏è Merge Conflicts Detected\n\n**Overseer-Prime** has detected merge conflicts in this PR.\n\n**Action Required**: Please resolve conflicts or the system will attempt auto-resolution.\n\n**Status**: CONFLICT_DETECTED\n**Next Step**: Auto-resolution attempt in progress'
                    });
                    
                    continue;
                  }
                  
                  // Check if enough time has passed (at least 2 minutes since last update)
                  const lastUpdate = new Date(pr.updated_at);
                  const now = new Date();
                  const minutesSinceUpdate = (now - lastUpdate) / 1000 / 60;
                  
                  if (minutesSinceUpdate > 2 && !anyChecksFailed) {
                    console.log(`  ‚úÖ Converting PR #${prNumber} to ready for review`);
                    
                    try {
                      await github.rest.pulls.update({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: parseInt(prNumber),
                        draft: false
                      });
                      
                      await github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: parseInt(prNumber),
                        body: '## üöÄ PR Ready for Review\n\n**Overseer-Prime** has automatically converted this PR to ready for review.\n\n**Status**: READY_FOR_REVIEW\n**Next Step**: Auto-merge on CI pass\n\n---\n*Autonomous operation via Ouroboros Protocol*'
                      });
                      
                      console.log(`  ‚úÖ Successfully converted PR #${prNumber} to ready`);
                    } catch (error) {
                      console.error(`  ‚ùå Failed to convert PR #${prNumber}:`, error.message);
                    }
                  } else {
                    console.log(`  ‚è≥ Waiting for checks to complete (${minutesSinceUpdate.toFixed(1)}m since update)`);
                  }
                } else {
                  console.log(`  ‚úÖ PR #${prNumber} is already ready for review`);
                }
                
              } catch (error) {
                console.error(`  ‚ùå Error processing PR #${prNumber}:`, error.message);
              }
            }
            
            console.log('\n‚úÖ PR processing complete');
      
      - name: üìä Generate Summary
        run: |
          echo "# üé≠ PR Orchestrator Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**PRs Discovered**: ${{ steps.discover.outputs.pr_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Autonomous Operations" >> $GITHUB_STEP_SUMMARY
          echo "- üéØ Draft-to-Ready conversion" >> $GITHUB_STEP_SUMMARY
          echo "- üîç Conflict detection" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Check validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Orchestrated by Overseer-Prime*" >> $GITHUB_STEP_SUMMARY

  conflict-resolution:
    name: üîß Conflict Resolution
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîç Check for Conflicts
        id: conflicts
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName !== 'pull_request') {
              console.log('Not a pull request event, skipping');
              return 'skip';
            }
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            console.log('üîç CONFLICT DETECTION');
            console.log('====================');
            console.log(`PR #${pr.number}: ${pr.title}`);
            console.log(`Mergeable: ${pr.mergeable}`);
            console.log(`Mergeable State: ${pr.mergeable_state}`);
            
            if (pr.mergeable === false) {
              console.log('‚ö†Ô∏è  CONFLICTS DETECTED');
              return 'conflicts';
            } else if (pr.mergeable === null) {
              console.log('‚è≥ Mergeable status not yet determined');
              return 'pending';
            } else {
              console.log('‚úÖ No conflicts detected');
              return 'clean';
            }
      
      - name: üîß Attempt Auto-Resolution
        if: steps.conflicts.outputs.result == 'conflicts'
        run: |
          echo "üîß CONFLICT AUTO-RESOLUTION"
          echo "=========================="
          
          # Configure git
          git config user.name "Overseer-Prime"
          git config user.email "overseer@construct-os.infinityxonesystems.com"
          
          # Fetch latest main
          git fetch origin main
          
          # Check current branch
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "Current branch: $CURRENT_BRANCH"
          
          # Attempt rebase
          echo "Attempting rebase against main..."
          if git rebase origin/main; then
            echo "‚úÖ Rebase successful"
            git push --force-with-lease
          else
            echo "‚ùå Rebase failed, conflicts require manual resolution"
            git rebase --abort
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üìù Update PR Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName !== 'pull_request') {
              return;
            }
            
            const status = '${{ steps.conflicts.outputs.result }}';
            const resolutionSuccess = '${{ steps.attempt-resolution.outcome }}' === 'success';
            
            let message = '';
            
            if (status === 'conflicts') {
              if (resolutionSuccess) {
                message = '## ‚úÖ Conflicts Resolved\n\n**Overseer-Prime** has automatically resolved merge conflicts via rebase.\n\n**Status**: CLEAN\n**Action**: Ready for auto-merge';
              } else {
                message = '## ‚ö†Ô∏è Manual Conflict Resolution Required\n\n**Overseer-Prime** attempted automatic conflict resolution but was unsuccessful.\n\n**Status**: REQUIRES_MANUAL_RESOLUTION\n**Action**: Please resolve conflicts manually';
              }
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: message
              });
            }
